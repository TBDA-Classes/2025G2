

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODE REFERENCE &mdash; Numerical Control Machine 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=f2a433a1"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MAIN QUERIES" href="queries.html" />
    <link rel="prev" title="PROJECT REQUIREMENTS &amp; COMPLIANCE" href="requirements.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Numerical Control Machine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">INTRODUCTION</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#project-overview">Project Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#project-needs">Project Needs</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#solution-approach">Solution approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#team-of-the-project">Team of the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#where-to-go-next">Where to go next</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">SYSTEM ARCHITECTURE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#system-architecture-diagram">System Architecture Diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#dual-database-strategy">Dual-Database Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#frontendbackend-interaction">Frontend–Backend Interaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#dashboard-data-requirements">Dashboard Data Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backend.html">BACKEND OVERVIEW</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backend.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#backend-file-structure">Backend File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#database-driver">Database Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#running-the-backend">Running the Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#api-endpoints">API Endpoints</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="frontend.html">FRONTEND OVERVIEW</a><ul>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#project-structure">Project Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#setup-instructions">Setup Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#routes-implemented">Routes implemented</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#ui-components">UI Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#data-flow">Data Flow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="db_sql.html">SQL DATABASE AND DATA ANALYSIS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="db_sql.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="db_sql.html#cnc-machine-status-semantics">CNC Machine Status Semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="db_sql.html#data-extraction-strategy">Data Extraction Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="db_sql.html#data-aggregation-strategy">Data Aggregation Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="db_sql.html#indexing-strategy">Indexing Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="db_sql.html#views">Views</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="db_sql.html#connecting-to-postgresql">Connecting to PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="db_sql.html#json-and-sql-operations">JSON and SQL Operations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ui_ux.html">UI / UX DESIGN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#design-goals">Design Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#global-layout-and-navigation">Global Layout and Navigation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#machine-utilisation-cards">Machine Utilisation Cards</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#machine-status-timeline">Machine Status Timeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#temperature-and-program-history">Temperature and Program History</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#energy-screen">Energy Screen</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#alerts-screen">Alerts Screen</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#summary-view">Summary View</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#alert-list-and-detail">Alert List and Detail</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#collaboration-with-frontend-and-data-teams">Collaboration with Frontend and Data Teams</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="devops.html">DEVOPS &amp; DEPLOYMENT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="devops.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#deployment-architecture">Deployment Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#frontend-deployment-vercel">Frontend Deployment (Vercel)</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#backend-deployment">Backend Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#backend-environment-configuration">Backend Environment Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#etl-scripts-execution">ETL Scripts Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#database-deployment-considerations">Database Deployment Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#operational-workflow-summary">Operational Workflow Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#logging-and-monitoring">Logging and Monitoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">PROJECT REQUIREMENTS &amp; COMPLIANCE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#functional-requirements">Functional Requirements</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CODE REFERENCE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#backend-scripts">Backend Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#aggregation-database-creation-script">Aggregation Database Creation Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#etl-scripts-overview">ETL Scripts Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#daily-etl-runner-script">Daily ETL Runner Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#core-backend-code">Core Backend Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#database-connection-layer">Database Connection Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#orm-models">ORM Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-application-entry-point">API Application Entry Point</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="queries.html">MAIN QUERIES</a><ul>
<li class="toctree-l2"><a class="reference internal" href="queries.html#machine-utilization-queries">Machine Utilization Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#machine-utilization-percentages">Machine Utilization (Percentages)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#program-history-queries">Program History Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#program-history-24-hours">Program History (24 Hours)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#temperature-queries">Temperature Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#temperature-history-24-hours">Temperature History (24 Hours)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#energy-consumption-queries">Energy Consumption Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#hourly-consumption">Hourly Consumption</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#energy-by-shift">Energy by Shift</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#alarm-queries">Alarm Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#alarm-count-by-category">Alarm Count by Category</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#alarm-count-by-shift-and-category">Alarm Count by Shift and Category</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#full-list-of-alerts">Full List of Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#alarm-detail-for-a-specific-code">Alarm Detail for a Specific Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Numerical Control Machine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">CODE REFERENCE</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/code.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="code-reference">
<h1>CODE REFERENCE<a class="headerlink" href="#code-reference" title="Link to this heading"></a></h1>
<p>This page centralizes the most relevant source code used in the project.
The codebase is divided into two clearly differentiated categories:</p>
<ul class="simple">
<li><p><strong>Backend Scripts</strong>: standalone scripts responsible for ETL processes and
batch aggregation tasks.</p></li>
<li><p><strong>Core Backend Code</strong>: reusable infrastructure and data models used by the
backend services and APIs.</p></li>
</ul>
<p>This separation helps distinguish between <em>operational logic</em> (scripts) and
<em>structural logic</em> (core code).</p>
<section id="backend-scripts">
<h2>Backend Scripts<a class="headerlink" href="#backend-scripts" title="Link to this heading"></a></h2>
<p>This section documents backend scripts used to populate and maintain the
aggregation database. These scripts are typically executed manually or through
scheduled jobs and are not part of the request–response API flow.</p>
<section id="aggregation-database-creation-script">
<h3>Aggregation Database Creation Script<a class="headerlink" href="#aggregation-database-creation-script" title="Link to this heading"></a></h3>
<p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">create_agg_database.sql</span></code></p>
<p>This script creates all tables, indexes, and views required for the aggregation
database.</p>
<p><strong>Execution example</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>psql<span class="w"> </span>machine_monitoring_agg<span class="w"> </span>-f<span class="w"> </span>create_agg_database.sql
</pre></div>
</div>
<p>—</p>
<p><strong>Sample Aggregated Tables</strong></p>
<p>The following examples illustrate the structure of the aggregation tables.
All tables follow a similar pattern with date-based primary keys and
computed/derived metrics.</p>
<p><em>Daily Machine Activity:</em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">agg_machine_activity_daily</span><span class="w"> </span><span class="p">(</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="n">dt</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="n">state_planned_down</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="n">state_running</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">state_unplanned_down</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">running_percentage</span><span class="w"> </span><span class="nb">NUMERIC</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="k">GENERATED</span><span class="w"> </span><span class="n">ALWAYS</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="linenos"> 8</span><span class="w">            </span><span class="n">ROUND</span><span class="p">((</span><span class="n">state_running</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="n">STORED</span><span class="p">,</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">down_percentage</span><span class="w"> </span><span class="nb">NUMERIC</span>
<span class="linenos">11</span><span class="w">        </span><span class="k">GENERATED</span><span class="w"> </span><span class="n">ALWAYS</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="linenos">12</span><span class="w">            </span><span class="n">ROUND</span><span class="p">((</span><span class="n">state_planned_down</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">13</span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="n">STORED</span><span class="p">,</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">last_updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="linenos">15</span><span class="p">);</span>
</pre></div>
</div>
<p><em>Aggregated Sensor Statistics:</em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">agg_sensor_stats</span><span class="w"> </span><span class="p">(</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="n">sensor_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="n">dt</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="n">min_value</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="n">avg_value</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">max_value</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">std_dev</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">readings_count</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">last_updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="linenos">10</span><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">sensor_name</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span>
<span class="linenos">11</span><span class="p">);</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">idx_sensor_date</span>
<span class="linenos">14</span><span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">agg_sensor_stats</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">,</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">dt</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">));</span>
</pre></div>
</div>
<p>Additional tables created by this script include: <code class="docutils literal notranslate"><span class="pre">alerts_daily_count</span></code>,
<code class="docutils literal notranslate"><span class="pre">alerts_detail</span></code>, <code class="docutils literal notranslate"><span class="pre">machine_program_data</span></code>, and <code class="docutils literal notranslate"><span class="pre">energy_consumption_hourly</span></code>.</p>
<p>—</p>
</section>
<section id="etl-scripts-overview">
<h3>ETL Scripts Overview<a class="headerlink" href="#etl-scripts-overview" title="Link to this heading"></a></h3>
<p>The project includes five ETL scripts, all following a consistent pattern:</p>
<ol class="arabic simple">
<li><p><strong>Extract</strong>: Query raw data from the production database</p></li>
<li><p><strong>Transform</strong>: Aggregate or reshape data as needed</p></li>
<li><p><strong>Load</strong>: Store results in the aggregation database using upsert semantics</p></li>
</ol>
<p><strong>Available ETL Scripts:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">etl_agg_alerts.py</span></code> – Aggregates daily alert counts and stores critical alert details</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">etl_agg_program_history.py</span></code> – Computes program execution durations per day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">etl_agg_sensor_stats.py</span></code> – Calculates hourly sensor statistics (min, max, avg, std_dev)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">etl_agg_utilization.py</span></code> – Derives daily machine running hours vs. downtime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">etl_agg_energy_daily.py</span></code> – Calculates hourly energy consumption from motor utilization</p></li>
</ul>
<p>All scripts support three execution modes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Single day</span>
python<span class="w"> </span>-m<span class="w"> </span>backend.scripts.etl_agg_alerts<span class="w"> </span><span class="m">2022</span>-02-23

<span class="c1"># Date range</span>
python<span class="w"> </span>-m<span class="w"> </span>backend.scripts.etl_agg_alerts<span class="w"> </span><span class="m">2022</span>-02-01<span class="w"> </span><span class="m">2022</span>-02-28

<span class="c1"># Full historical backfill (no arguments)</span>
python<span class="w"> </span>-m<span class="w"> </span>backend.scripts.etl_agg_alerts
</pre></div>
</div>
<p>—</p>
<p><strong>Representative ETL Example: Alerts Aggregation</strong></p>
<p>The following snippets from <code class="docutils literal notranslate"><span class="pre">etl_agg_alerts.py</span></code> illustrate the common ETL
pattern used across all scripts.</p>
<p><em>Extraction – Daily Alert Counts:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">extract_daily_count</span><span class="p">(</span><span class="n">target_date</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 3</span>        <span class="k">with</span> <span class="n">prod_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="linenos"> 4</span>            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39; SQL QUERY OMITTED FOR BREVITY &#39;&#39;&#39;</span>
<span class="linenos"> 5</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;target_date&#39;</span><span class="p">:</span> <span class="n">target_date</span><span class="p">})</span>
<span class="linenos"> 6</span>            <span class="n">rows</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>            <span class="k">return</span> <span class="p">[</span>
<span class="linenos"> 9</span>                <span class="p">{</span>
<span class="linenos">10</span>                    <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="n">target_date</span><span class="p">,</span>
<span class="linenos">11</span>                    <span class="s1">&#39;alert_type&#39;</span><span class="p">:</span> <span class="n">ALERT_TYPE_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">alert_type</span><span class="p">),</span>
<span class="linenos">12</span>                    <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">total_occurrences</span>
<span class="linenos">13</span>                <span class="p">}</span>
<span class="linenos">14</span>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span>
<span class="linenos">15</span>                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">alert_type</span> <span class="ow">in</span> <span class="n">ALERT_TYPE_MAP</span>
<span class="linenos">16</span>            <span class="p">]</span>
<span class="linenos">17</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">18</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract daily count: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">19</span>        <span class="k">raise</span>
</pre></div>
</div>
<p><em>Load – Using Upsert Semantics:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">load_daily_count</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
<span class="linenos"> 3</span>        <span class="k">return</span> <span class="mi">0</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">agg_engine</span><span class="p">)</span>
<span class="linenos"> 6</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="linenos"> 8</span>            <span class="n">alert_count</span> <span class="o">=</span> <span class="n">AlertsDailyCount</span><span class="p">(</span>
<span class="linenos"> 9</span>                <span class="n">day</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">],</span>
<span class="linenos">10</span>                <span class="n">alert_type</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;alert_type&#39;</span><span class="p">],</span>
<span class="linenos">11</span>                <span class="n">amount</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
<span class="linenos">12</span>            <span class="p">)</span>
<span class="linenos">13</span>            <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">alert_count</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span>        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">16</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">17</span>
<span class="linenos">18</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">19</span>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="linenos">20</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load of daily count failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">21</span>        <span class="k">raise</span>
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">24</span>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p><em>ETL Orchestration:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">run_etl</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="c1"># For full backfill, get min/max dates from source data</span>
<span class="linenos"> 3</span>    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 4</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No dates provided, querying date range for full backfill...&quot;</span><span class="p">)</span>
<span class="linenos"> 5</span>        <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">get_date_range</span><span class="p">()</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="c1"># Process each date in the range</span>
<span class="linenos"> 8</span>    <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 9</span>    <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span>    <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;=</span> <span class="n">end_dt</span><span class="p">:</span>
<span class="linenos">12</span>        <span class="n">date_str</span> <span class="o">=</span> <span class="n">current_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">13</span>        <span class="n">daily_count_data</span> <span class="o">=</span> <span class="n">extract_daily_count</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
<span class="linenos">14</span>        <span class="k">if</span> <span class="n">daily_count_data</span><span class="p">:</span>
<span class="linenos">15</span>            <span class="n">load_daily_count</span><span class="p">(</span><span class="n">daily_count_data</span><span class="p">)</span>
<span class="linenos">16</span>        <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>—</p>
</section>
<section id="daily-etl-runner-script">
<h3>Daily ETL Runner Script<a class="headerlink" href="#daily-etl-runner-script" title="Link to this heading"></a></h3>
<p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">etl_daily_runner.py</span></code></p>
<p>This script orchestrates daily execution of all ETL scripts. It queries
<code class="docutils literal notranslate"><span class="pre">v_data_status</span></code> for the latest processed date and runs all ETL scripts
from that date to the current date.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">ETL_MODULES</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 2</span>    <span class="s2">&quot;backend.scripts.etl_agg_sensor_stats&quot;</span><span class="p">,</span>
<span class="linenos"> 3</span>    <span class="s2">&quot;backend.scripts.etl_agg_utilization&quot;</span><span class="p">,</span>
<span class="linenos"> 4</span>    <span class="s2">&quot;backend.scripts.etl_agg_program_history&quot;</span><span class="p">,</span>
<span class="linenos"> 5</span>    <span class="s2">&quot;backend.scripts.etl_agg_alerts&quot;</span><span class="p">,</span>
<span class="linenos"> 6</span>    <span class="s2">&quot;backend.scripts.etl_agg_energy_daily&quot;</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="p">]</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">def</span><span class="w"> </span><span class="nf">run_all_etls</span><span class="p">(</span><span class="n">from_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">:</span> <span class="n">date</span><span class="p">):</span>
<span class="linenos">10</span>    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">ETL_MODULES</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_date</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">to_date</span><span class="p">)])</span>
<span class="linenos">12</span>        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">13</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> completed&quot;</span><span class="p">)</span>
<span class="linenos">14</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">15</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>—</p>
</section>
</section>
<section id="core-backend-code">
<h2>Core Backend Code<a class="headerlink" href="#core-backend-code" title="Link to this heading"></a></h2>
<p>This section documents reusable backend modules that define database access,
ORM models, and shared infrastructure.</p>
<p>—</p>
<section id="database-connection-layer">
<h3>Database Connection Layer<a class="headerlink" href="#database-connection-layer" title="Link to this heading"></a></h3>
<p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">database.py</span></code></p>
<p>This module centralizes all database connection logic. It manages connections to
a <strong>production database</strong> (read-only, raw data) and an <strong>aggregation database</strong>
(derived analytical data), and is designed for <strong>FastAPI dependency injection</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos"> 2</span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="linenos"> 3</span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="linenos"> 4</span><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="linenos"> 5</span><span class="n">load_dotenv</span><span class="p">()</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="c1"># Production Database</span>
<span class="linenos"> 8</span><span class="n">PROD_DATABASE_URL</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 9</span>    <span class="sa">f</span><span class="s2">&quot;postgresql+psycopg://</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DB_USER&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DB_PASSWORD&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">10</span>    <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DB_HOST&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DB_PORT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2345&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DB_NAME&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">11</span><span class="p">)</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="n">prod_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
<span class="linenos">14</span>    <span class="n">PROD_DATABASE_URL</span><span class="p">,</span>
<span class="linenos">15</span>    <span class="n">pool_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="linenos">16</span>    <span class="n">max_overflow</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="linenos">17</span>    <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">18</span>    <span class="n">pool_recycle</span><span class="o">=</span><span class="mi">1800</span>
<span class="linenos">19</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="n">ProductionSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">prod_engine</span><span class="p">)</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="k">def</span><span class="w"> </span><span class="nf">get_prod_db</span><span class="p">():</span>
<span class="linenos">24</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dependency for FastAPI endpoints that read from production database&quot;&quot;&quot;</span>
<span class="linenos">25</span>    <span class="n">db</span> <span class="o">=</span> <span class="n">ProductionSession</span><span class="p">()</span>
<span class="linenos">26</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">27</span>        <span class="k">yield</span> <span class="n">db</span>
<span class="linenos">28</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">29</span>        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="c1"># Aggregation Database follows the same pattern with AGG_DB_NAME</span>
</pre></div>
</div>
<p>—</p>
</section>
<section id="orm-models">
<h3>ORM Models<a class="headerlink" href="#orm-models" title="Link to this heading"></a></h3>
<p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">models.py</span></code></p>
<p>Defines SQLAlchemy ORM models using SQLAlchemy 2.0 typed mappings.</p>
<p><em>Production Database Models:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span><span class="w"> </span><span class="nc">Variable</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;variable&quot;</span>
<span class="linenos">3</span>
<span class="linenos">4</span>    <span class="nb">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">5</span>    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="linenos">6</span>    <span class="n">datatype</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="linenos">7</span>
<span class="linenos">8</span>    <span class="n">variable_log_floats</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;VariableLogFloat&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
<span class="linenos">9</span>    <span class="n">variable_log_strings</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;VariableLogString&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Sample Aggregation Models:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span><span class="w"> </span><span class="nc">AggMachineActivityDaily</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Daily machine utilization: running hours vs. downtime hours.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;agg_machine_activity_daily&quot;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="n">dt</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 6</span>    <span class="n">state_planned_down</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 7</span>    <span class="n">state_running</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 8</span>    <span class="n">state_unplanned_down</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 9</span>    <span class="n">last_updated_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]]</span>
<span class="linenos">10</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">class</span><span class="w"> </span><span class="nc">AggSensorStats</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="linenos">13</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Hourly aggregated sensor statistics.&quot;&quot;&quot;</span>
<span class="linenos">14</span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;agg_sensor_stats&quot;</span>
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="n">sensor_name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">17</span>    <span class="n">dt</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">18</span>    <span class="n">min_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
<span class="linenos">19</span>    <span class="n">avg_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
<span class="linenos">20</span>    <span class="n">max_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
<span class="linenos">21</span>    <span class="n">std_dev</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
<span class="linenos">22</span>    <span class="n">readings_count</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
<span class="linenos">23</span>    <span class="n">last_updated_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]]</span>
</pre></div>
</div>
<p>Additional models include: <code class="docutils literal notranslate"><span class="pre">MachineProgramData</span></code>, <code class="docutils literal notranslate"><span class="pre">AlertsDailyCount</span></code>,
<code class="docutils literal notranslate"><span class="pre">AlertsDetail</span></code>, and <code class="docutils literal notranslate"><span class="pre">EnergyConsumptionHourly</span></code>.</p>
<p>—</p>
</section>
<section id="api-application-entry-point">
<h3>API Application Entry Point<a class="headerlink" href="#api-application-entry-point" title="Link to this heading"></a></h3>
<p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">main.py</span></code></p>
<p>Defines the <strong>FastAPI application</strong> with REST endpoints for analytics and
monitoring. Provides read-only access to both the production and aggregation
databases.</p>
<p><em>Application Setup:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="linenos"> 2</span><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Variable Monitoring API&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<span class="linenos"> 7</span>    <span class="n">CORSMiddleware</span><span class="p">,</span>
<span class="linenos"> 8</span>    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">],</span>
<span class="linenos"> 9</span>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">],</span>
<span class="linenos">10</span>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="linenos">11</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Sample Response Models:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span><span class="w"> </span><span class="nc">SensorStatsOut</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">dt</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos"> 3</span>    <span class="n">min_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 4</span>    <span class="n">avg_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 5</span>    <span class="n">max_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 6</span>    <span class="n">std_dev</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos"> 7</span>    <span class="n">readings_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">class</span><span class="w"> </span><span class="nc">MachineUtilOut</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="linenos">10</span>    <span class="n">dt</span><span class="p">:</span> <span class="nb">str</span>
<span class="linenos">11</span>    <span class="n">state_running</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos">12</span>    <span class="n">state_planned_down</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos">13</span>    <span class="n">running_percentage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
<span class="linenos">14</span>    <span class="n">down_percentage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
</pre></div>
</div>
<p><em>Sample Endpoint:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/temperature&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">SensorStatsOut</span><span class="p">])</span>
<span class="linenos"> 2</span><span class="k">def</span><span class="w"> </span><span class="nf">get_temperature_stats</span><span class="p">(</span>
<span class="linenos"> 3</span>    <span class="n">target_date</span><span class="p">:</span> <span class="n">DateType</span><span class="p">,</span>
<span class="linenos"> 4</span>    <span class="n">sensor_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos"> 5</span>    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_agg_db</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="p">):</span>
<span class="linenos"> 7</span>    <span class="n">query</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos"> 8</span><span class="s2">        SELECT dt, min_value, avg_value, max_value, std_dev, readings_count</span>
<span class="linenos"> 9</span><span class="s2">        FROM agg_sensor_stats</span>
<span class="linenos">10</span><span class="s2">        WHERE dt::date = :target_date AND sensor_name = :sensor_name</span>
<span class="linenos">11</span><span class="s2">        ORDER BY dt ASC</span>
<span class="linenos">12</span><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<span class="linenos">13</span>    <span class="c1"># ...</span>
</pre></div>
</div>
<p><strong>Available API Endpoints:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/status</span></code> – Health check and database connection status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/temperature</span></code> – Hourly sensor statistics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/machine_util</span></code> – Daily machine utilization metrics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/data_status</span></code> – Overview of available data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/alerts_daily_count</span></code> – Aggregated daily alert counts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/alerts_detail</span></code> – Detailed alert records</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/machine_program</span></code> – Program execution durations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/api/v1/energy_consumption</span></code> – Hourly energy consumption</p></li>
</ul>
<p>—</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="requirements.html" class="btn btn-neutral float-left" title="PROJECT REQUIREMENTS &amp; COMPLIANCE" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="queries.html" class="btn btn-neutral float-right" title="MAIN QUERIES" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TBDA-G2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>