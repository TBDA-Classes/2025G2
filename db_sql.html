

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SQL DATABASE AND DATA ANALYSIS &mdash; Numerical Control Machine 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=f2a433a1"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="UI / UX DESIGN" href="ui_ux.html" />
    <link rel="prev" title="FRONTEND OVERVIEW" href="frontend.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Numerical Control Machine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">INTRODUCTION</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#project-overview">Project Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#project-needs">Project Needs</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#solution-approach">Solution approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#team-of-the-project">Team of the Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#where-to-go-next">Where to go next</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">SYSTEM ARCHITECTURE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#system-architecture-diagram">System Architecture Diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#dual-database-strategy">Dual-Database Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#frontendbackend-interaction">Frontend–Backend Interaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#dashboard-data-requirements">Dashboard Data Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backend.html">BACKEND OVERVIEW</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backend.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#backend-file-structure">Backend File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#database-driver">Database Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#environment-variables">Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#running-the-backend">Running the Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="backend.html#api-endpoints">API Endpoints</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="frontend.html">FRONTEND OVERVIEW</a><ul>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#project-structure">Project Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#setup-instructions">Setup Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#routes-implemented">Routes implemented</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#ui-components">UI Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html#data-flow">Data Flow</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SQL DATABASE AND DATA ANALYSIS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cnc-machine-status-semantics">CNC Machine Status Semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-extraction-strategy">Data Extraction Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-aggregation-strategy">Data Aggregation Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#indexing-strategy">Indexing Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#views">Views</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#connecting-to-postgresql">Connecting to PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#json-and-sql-operations">JSON and SQL Operations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ui_ux.html">UI / UX DESIGN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#design-goals">Design Goals</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#global-layout-and-navigation">Global Layout and Navigation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#machine-utilisation-cards">Machine Utilisation Cards</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#machine-status-timeline">Machine Status Timeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#temperature-and-program-history">Temperature and Program History</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#energy-screen">Energy Screen</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#alerts-screen">Alerts Screen</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#summary-view">Summary View</a></li>
<li class="toctree-l3"><a class="reference internal" href="ui_ux.html#alert-list-and-detail">Alert List and Detail</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_ux.html#collaboration-with-frontend-and-data-teams">Collaboration with Frontend and Data Teams</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="devops.html">DEVOPS &amp; DEPLOYMENT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="devops.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#deployment-architecture">Deployment Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#frontend-deployment-vercel">Frontend Deployment (Vercel)</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#backend-deployment">Backend Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#backend-environment-configuration">Backend Environment Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#etl-scripts-execution">ETL Scripts Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#database-deployment-considerations">Database Deployment Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#operational-workflow-summary">Operational Workflow Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="devops.html#logging-and-monitoring">Logging and Monitoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">PROJECT REQUIREMENTS &amp; COMPLIANCE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#functional-requirements">Functional Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="code.html">CODE REFERENCE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="code.html#backend-scripts">Backend Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="code.html#aggregation-database-creation-script">Aggregation Database Creation Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="code.html#alerts-aggregation-etl-script">Alerts Aggregation ETL Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="code.html#machine-program-history-etl-script">Machine Program History ETL Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="code.html#sensor-statistics-etl-script">Sensor Statistics ETL Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="code.html#machine-utilization-etl-script">Machine Utilization ETL Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="code.html#core-backend-code">Core Backend Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="code.html#database-connection-layer">Database Connection Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="code.html#orm-models">ORM Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="code.html#api-application-entry-point">API Application Entry Point</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="queries.html">MAIN QUERIES</a><ul>
<li class="toctree-l2"><a class="reference internal" href="queries.html#machine-utilization-queries">Machine Utilization Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#machine-utilization-percentages">Machine Utilization (Percentages)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#program-history-queries">Program History Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#program-history-24-hours">Program History (24 Hours)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#temperature-queries">Temperature Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#temperature-history-24-hours">Temperature History (24 Hours)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#energy-consumption-queries">Energy Consumption Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#hourly-consumption">Hourly Consumption</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#energy-by-shift">Energy by Shift</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="queries.html#alarm-queries">Alarm Queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="queries.html#alarm-count-by-category">Alarm Count by Category</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#alarm-count-by-shift-and-category">Alarm Count by Shift and Category</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#full-list-of-alerts">Full List of Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="queries.html#alarm-detail-for-a-specific-code">Alarm Detail for a Specific Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Numerical Control Machine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">SQL DATABASE AND DATA ANALYSIS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/db_sql.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sql-database-and-data-analysis">
<h1>SQL DATABASE AND DATA ANALYSIS<a class="headerlink" href="#sql-database-and-data-analysis" title="Link to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>The project relies on two PostgreSQL databases:</p>
<ol class="arabic simple">
<li><p><strong>Production Database:</strong>
Large-scale raw CNC sensor dataset.</p></li>
<li><p><strong>Aggregation Database:</strong>
Lightweight, query-optimized database built via custom ETL processes.</p></li>
</ol>
<p>The Data Analysis Team was responsible for understanding the production schema,
extracting relevant information, and enabling efficient querying through aggregation.</p>
</section>
<section id="cnc-machine-status-semantics">
<h2>CNC Machine Status Semantics<a class="headerlink" href="#cnc-machine-status-semantics" title="Link to this heading"></a></h2>
<p>A CNC machine can be in one of several states:</p>
<ul class="simple">
<li><p><strong>RUN</strong> – actively processing a part</p></li>
<li><p><strong>IDLE</strong> – powered on but not processing</p></li>
<li><p><strong>DOWN</strong> – emergency stop or failure</p></li>
</ul>
<p>Raw data reflects:</p>
<ul class="simple">
<li><p>Status changes</p></li>
<li><p>Temperature samples</p></li>
<li><p>Program execution logs</p></li>
<li><p>Power usage</p></li>
<li><p>Alerts and timestamps</p></li>
</ul>
</section>
<section id="data-extraction-strategy">
<h2>Data Extraction Strategy<a class="headerlink" href="#data-extraction-strategy" title="Link to this heading"></a></h2>
<p>The production database schema contains:</p>
<ul>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">machine_state`</span></code></dt><dd><p>For Machine Operation: The query for this part identifies if
the machine is operating based on the variable Machine_in_operation,
which is a boolean.</p>
<p>For Machine Utilization: The query used analyzes variable changes in
fixed 10-minute blocks to determine the utilization level of the
machine. If there are no variable changes within a block, the
machine is considered to be turned off. In the case that there are
30 variable changes or less in a block, the machine is considered
to be Idle. Finally, if there are more than 30 variable changes
registered within the block, the machine is considered to be running.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">temperature_readings</span></code></dt><dd><p>The query used retrieves the values of temperature variables
registered from different parts of the machine. It is important to
note that the query excludes non-significant temperature variables
(in other words, variables that only register zeros or NaNs).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">alerts</span></code></dt><dd><p>We assumed that alarm severity could be accurately determined by searching
for specific keywords in the alarm descriptions, grouping them into three categories
(Emergency, Error, Alert) based on linguistic patterns rather than explicit severity codes.
We also assumed the timestamp format required conversion from milliseconds and that shifts could
be calculated directly from the time portion of each alarm’s timestamp.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">program_usage</span></code></dt><dd><p>The query used identifies the states registered for the variable
Program Status (Prog_Status). It assumes a persistence logic:
once a state is registered, the machine remains in that state
until a new one is recorded. Crucially, it also retrieves the
last state from the previous day to account for the time starting
exactly at 00:00:00. Finally, the query calculates the total
duration in seconds for each state during the entire day.</p>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">power_consumption</span></code></dt><dd><p>Since the database doesn’t give us real energy values, we estimate
it using the motor utilization percentages. Each motor has a known
nominal power (kW), so we assume that its real power at any moment
is (utilization% × nominal kW). We then calculate how long each
utilization value stays active and convert that into energy (kWh).
Finally, we culminate the first query by adding up all these segments
and then grouping the results by hour to create the hourly energy
chart.</p>
<p>The second query used simply retrieves all temperature values from
thesensors we found to be reliable. We convert the timestamps
from milliseconds to seconds and filter the data to a specific 24
hour period. The result is a clean list of temperature readings
over time, which is what the frontend needs for plotting the
temperature graph.</p>
</dd>
</dl>
</li>
</ul>
<p>The Data Analysis Team ingested these tables to compute:</p>
<ul class="simple">
<li><p>24-hour status distributions</p></li>
<li><p>Per-shift aggregations</p></li>
<li><p>Program history</p></li>
<li><p>Temperature history</p></li>
<li><p>Energy consumption patterns</p></li>
<li><p>Emergent alerts by severity</p></li>
<li><p>Coverage of available dates</p></li>
</ul>
</section>
<section id="data-aggregation-strategy">
<h2>Data Aggregation Strategy<a class="headerlink" href="#data-aggregation-strategy" title="Link to this heading"></a></h2>
<p>The production database contains millions of rows. To ensure interactive performance in the frontend:</p>
<ul class="simple">
<li><p>ETL scripts extract raw sensor data</p></li>
<li><p>Transform it through SQL and Python logic</p></li>
<li><p>Load computed summaries into the aggregation DB</p></li>
</ul>
<section id="indexing-strategy">
<h3>Indexing Strategy<a class="headerlink" href="#indexing-strategy" title="Link to this heading"></a></h3>
<p>B-Tree indexes are used for reducing lookup time significantly.</p>
</section>
<section id="views">
<h3>Views<a class="headerlink" href="#views" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">v_data_status</span></code> view provides:</p>
<ul class="simple">
<li><p>Global first/last date across all aggregated tables</p></li>
<li><p>Record counts per table (sensors, utilization, alerts, programs, energy)</p></li>
<li><p>Used by the frontend datepicker to restrict selectable dates</p></li>
</ul>
</section>
</section>
<section id="connecting-to-postgresql">
<h2>Connecting to PostgreSQL<a class="headerlink" href="#connecting-to-postgresql" title="Link to this heading"></a></h2>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span> <span class="mf">138.100.82.184</span> <span class="o">-</span><span class="n">U</span> <span class="n">lectura</span> <span class="o">-</span><span class="n">d</span> <span class="o">&lt;</span><span class="n">database</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">p</span> <span class="mi">2345</span>
</pre></div>
</div>
<p>Useful psql commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\l</span></code> – list databases</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\dt</span></code> – list tables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\dv</span></code> – list views</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\d</span> <span class="pre">table</span></code> – describe schema</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\conninfo</span></code> – connection info</p></li>
</ul>
</section>
<section id="json-and-sql-operations">
<h2>JSON and SQL Operations<a class="headerlink" href="#json-and-sql-operations" title="Link to this heading"></a></h2>
<p>Relevant PostgreSQL operators used during analysis:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">-&gt;&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jsonb_array_elements</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jsonb_each_text</span></code></p></li>
<li><p>Window functions (<code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, <code class="docutils literal notranslate"><span class="pre">HAVING</span></code></p></li>
</ul>
<p>These allowed the team to transform nested or
semi-structured sensor logs into usable units for aggregation.</p>
<p>See <a class="reference internal" href="queries.html"><span class="doc">MAIN QUERIES</span></a> for SQL queries used during analysis and validation.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="frontend.html" class="btn btn-neutral float-left" title="FRONTEND OVERVIEW" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ui_ux.html" class="btn btn-neutral float-right" title="UI / UX DESIGN" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TBDA-G2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>